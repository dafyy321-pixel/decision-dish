# 《等会吃啥》项目进度分析与实施计划（已对齐当前代码）

## 📊 项目完成度概览（更新）

- 已实现（MVP v1.0）
  - 随机抽取 + 转盘动画（12 扇形）
  - 模式切换：系统推荐 / 自定义
  - 自定义列表：新增/删除/校验（最多 20 项），本地持久化
  - 历史记录：自动保存最近 100 次，历史页查看/删除/清空，支持一键收藏
  - 收藏：结果页一键收藏；收藏页查看/删除/清空；自定义列表支持从收藏添加
  - 分享：微信/QQ 唤起、复制链接、二维码生成
  - 个人中心：总次数/收藏数/历史数/最后抽取时间 + 最常选择 Top5
  - UI/导航：底部导航、反馈卡片（问卷二维码、微信群）
  - 数据源：已接入 Supabase 读取餐厅数据；页面内具备“为空回退本地预设”逻辑

- 待完善（技术债）
  - 未配置 .env 时的静默降级：`src/lib/supabase.ts` 仍抛错，阻断回退流程（见 SUPABASE_SETUP.md 方案）
  - 历史记录写入存在重复路径：`Index.tsx` 与 `ResultDisplay.tsx` 均在写入（需合并为单点）

- 待开发（按优先级）
  - P1：数据导入/导出（JSON）
  - P1：GA4 埋点接入（核心事件）
  - P2：分享海报生成（html2canvas/dom-to-image）
  - P2：云端收藏同步（Supabase user_favorites + Auth + RLS）与云端历史记录表
  - P2：PWA 与离线能力
  - 探索：权重抽取 / 分类筛选 / 多人投票

---

## ✅ 事实对照（功能 → 代码位置）
- 抽取与转盘：`src/pages/Index.tsx`、`src/components/SpinWheel.tsx`
- 模式切换：`src/components/ModeSelector.tsx`
- 自定义列表：`src/components/CustomListManager.tsx`
- 结果展示/收藏：`src/components/ResultDisplay.tsx`、`src/pages/Favorites.tsx`
- 历史记录：`src/pages/History.tsx`
- 分享：`src/pages/Share.tsx`
- 个人中心：`src/pages/Profile.tsx`
- Supabase：`src/lib/supabase.ts`、`src/hooks/useRestaurants.ts`、`src/types/database.types.ts`

---

## 🧩 实现细节与状态说明（对齐实际代码）

- 系统推荐模式（20 家本地预设 + 云端映射）
  - 文件：`src/data/restaurants.ts`、`src/pages/Index.tsx`
  - 逻辑：优先使用 `useRestaurants()` 的云端数据，否则回退到 `presetRestaurants`
  - 注：需先修复 `supabase.ts` 的静默降级方可在未配置 .env 时正常回退

- 自定义列表管理（本地）
  - 文件：`src/components/CustomListManager.tsx`
  - 特性：去重/数量上限校验、从本地“收藏”列表一键加入自定义列表

- 收藏（本地版已实现）
  - 入口：结果页爱心按钮（系统模式时可收藏）
  - 页面：`/favorites` 支持查看/删除/清空
  - 云端同步：预留 Hook `src/hooks/useFavorites.ts`，尚未接入 Auth 与 RLS

- 历史记录（本地）
  - 写入位置需统一：当前 `Index.tsx` 的 `handleWheelComplete` 与 `ResultDisplay.tsx` 的 `useEffect` 都会写入
  - 建议仅在 `ResultDisplay` 写入，并统一数据结构：`{ id, result, name, timestamp, mode }`

- 分享能力（已实现）
  - 微信/QQ 唤起（URL Scheme）+ Web Share API 兜底 + 复制链接 + 二维码生成

---

## 🔧 技术架构与 UI 现状

- 技术栈：React 18 + TypeScript + Vite + Tailwind + shadcn/ui + TanStack Query + React Router + Sonner
- 结构清晰：`components/pages/hooks/lib/types` 分层完整，页面和组件职责边界明确
- 设计一致：配色、圆角、动效与移动端优先布局均已落地

---

## 📅 里程碑与时间线（修订）

| 版本 | 时间范围 | 目标 | 关键功能 | 验收标准 |
| --- | --- | --- | --- | --- |
| v1.1 | 2025-11-03 ~ 2025-11-16 | 可记录与迁移数据 | ✅ 历史（含 UI）、❌ 导入导出 | ✅ 最近 100 条历史；❌ JSON 导入/导出 |
| v1.2 | 2025-11-17 ~ 2025-11-30 | 分享与沉淀 | 云端收藏同步、分享海报 | 本地/云端收藏一致；可生成/保存/复制海报 |
| v1.3 | 2025-12-01 ~ 2025-12-14 | 体验与增长 | PWA、GA4 | Lighthouse PWA ≥ 80；核心事件全量上报 |

DoD 清单
- [ ] v1.1 需求冻结 → 开发 → 自测 → 预发 → 上线
- [ ] v1.2 需求冻结 → 开发 → 自测 → 预发 → 上线
- [ ] v1.3 需求冻结 → 开发 → 自测 → 预发 → 上线

---

## 🐛 已知问题与修复建议（更新）

1) Supabase 未配置导致抛错中断
- 位置：`src/lib/supabase.ts`
- 建议：按 `SUPABASE_SETUP.md` 的“静默降级方案”改造，导出 `isSupabaseEnabled`，Hooks 内根据其返回空数组以触发回退

2) 历史记录重复写入
- 位置：`Index.tsx` 与 `ResultDisplay.tsx`
- 建议：统一写入位置，避免重复；并抽离写入工具函数以保持一致性

3) localStorage 写入缺少 try-catch 与用户提示
- 建议：写入失败时进行 Toast 提示并降级处理

---

## 🚀 下一步实施计划（可执行）

- P1
  1) 数据导入/导出组件 `DataImportExport.tsx`，并在自定义列表面板内接入
  2) GA4 埋点：mode_selected / draw_clicked / draw_result / draw_again
  3) Supabase 静默降级改造（supabase.ts + useRestaurants.ts）

- P2
  4) 收藏云端同步：启用 Auth、配置 RLS、实现本地与云端合并策略
  5) 分享海报：接入 `html2canvas`，输出高清图（≥2x）
  6) PWA：manifest、Service Worker、离线缓存策略

---

## ❓ 待确认事项（保持同步）
- 功能优先级：导入/导出 vs GA4 vs 分享海报 vs 云端收藏
- UI 放置：导入/导出入口建议放在自定义列表面板内，靠近“从收藏添加”按钮
- 是否采用“快速迭代”路径逐步上线

## 🎯 总结与建议

### 当前状态
✅ **MVP (v1.0) 已完成**  
所有核心 P0 功能已实现且质量良好，符合 PRD 设计规范，可以上线使用。

### 建议优先级
如果现在开始开发下一阶段功能，我建议：

**最优先**: 数据导入导出
- 理由：提升数据安全感，降低流失风险，技术实现直接

**第三优先**: GA4 埋点接入
- 理由：完善数据闭环，支持后续增长分析

**最后考虑**: 分享海报
- 理由：依赖额外库与设计资源，可后置

---

## ❓ 需要您确认的问题

在开始编写代码之前，请您确认：

1. **功能选择**: 您希望我先实现哪个功能？
   - [ ] 数据导入导出
   - [ ] GA4 埋点
   - [ ] 分享海报
   - [ ] 其他需求

2. **UI 位置偏好**: 
   - 历史记录放在哪里？（底部展开面板 / 独立页面 / 侧边栏）
   - 导入导出按钮放在哪里？（列表管理面板内 / 顶部工具栏）

3. **功能范围**:
   - 是否需要最小化实现（快速上线）还是完整实现（按 PRD 全部要求）？

4. **其他考虑**:
   - 是否需要先修复我发现的潜在问题？
   - 是否有其他优先级更高的需求？

**请告诉我您的决定，我会根据您的选择开始编写代码！** 🚀

